---
title: "Calculating stock weights"
author: "Kobus Viljoen"
date: "29 September 2016"
output: html_document
---

```{r}
knitr::opts_chunk$set(
  eval = FALSE)
```

##Necessary packages
```{r}
library(broom)
library(modelr)
library(ggplot2)
library(stringr)
library(dplyr)
library(tidyr)
library(purrr)
library(lubridate)
library(tibble)
```

In this file I want to calculate the weights assigned to each stock that is selected by the corresponding fundamental factor.
I'm going to use the risk parity approach.
At the end of the stock selection process, I'm left with a tibble with the corresponding semi-annual rebalancing dates in a vector and then a list of tibbles with the selected stocks corresponding to the dates.

## Merging the selected stocks with their daily log returns
```{r}
# close_price row number five consist out of the daily closing prices
# log returns are calculated using this function
log_returns <- function(df){
close <- df$"PX_LAST"
date <- filter(df,date>date[1]) %>% select(date)
ret <- tibble(date = date$date, log_ret = diff(log(close)))
}

logreturns <- close_prices$data[[5]] %>%
  bind_rows(.id = "Ticker") %>%
  group_by(Ticker) %>%
  nest()

logreturns <- logreturns %>% 
  mutate(logret = map(data,log_returns))

## This function takes the stocks list and dates from a specific model into account in collecting the daily return data for each selected stock
Returns <- function(df1,df2){
  Tickers <- df1 %>% select(Ticker)
  logreturns %>%
    unnest(logret) %>%
    group_by(Ticker) %>%
    filter(Ticker %in% Tickers$Ticker) %>%
    filter(date <= df2) %>%
    nest()
}
## Example for the momentum model
Closing <- MOM_Model %>% 
  mutate(Returns = map2(stocks,date,Returns))
```

## Market Cap weights for the momentum model
```{r}
MC_weights <- MOM_Model %>% mutate(MC_Weight = map(stocks,function(df){
  df %>%
    mutate(MC_Weight = Market_Cap/sum(Market_Cap)) %>%
    select(c(Ticker,MC_Weight))
}))

```




